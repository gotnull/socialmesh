name: Resend unsent bug reports

on:
  schedule:
    # Daily at 06:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch: {}

jobs:
  resend:
    environment: IMPROVMX_SMTP_USER
    name: Resend unsent reports
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-cloud-firestore python-dotenv

      - name: Check GCP service account secret
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          if [ -z "${GCP_SA_KEY}" ]; then
            echo "ERROR: GCP_SA_KEY secret is missing from the environment."
            echo "Create a service account with Firestore access, add its JSON as the environment secret named 'GCP_SA_KEY', then rerun this workflow."
            echo "Quick commands (local):"
            echo "  gcloud iam service-accounts create ci-firestore-resender --display-name 'CI Firestore Resender'"
            echo "  gcloud projects add-iam-policy-binding ${{ secrets.GCP_PROJECT_ID || 'YOUR_PROJECT_ID' }} --member=serviceAccount:ci-firestore-resender@$(gcloud config get-value project).iam.gserviceaccount.com --role=roles/datastore.user"
            echo "  gcloud iam service-accounts keys create key.json --iam-account=ci-firestore-resender@$(gcloud config get-value project).iam.gserviceaccount.com"
            echo "Then add the key as an Environment secret: 'GCP_SA_KEY' (use the UI or 'gh secret set GCP_SA_KEY --env "IMPROVMX_SMTP_USER" --body "$(cat key.json)"')."
            exit 1
          else
            echo "GCP_SA_KEY found. Continuing."
          fi

      - name: Validate GCP service account JSON
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          if [ -n "${GCP_SA_KEY}" ]; then
            # Validate JSON using Python so we get a clear error if it's malformed
            printf '%s' "${GCP_SA_KEY}" | python -c 'import sys, json
try:
    json.load(sys.stdin)
except Exception as e:
    print("Invalid JSON for GCP_SA_KEY:", e)
    sys.exit(1)'
            echo "GCP_SA_KEY JSON validated."
          else
            echo "No GCP_SA_KEY secret provided; skipping validation."
          fi

      - name: Write GCP service account key to file
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          if [ -n "${GCP_SA_KEY}" ]; then
            # Use printf to preserve exact file contents (avoid issues with echo)
            printf '%s' "${GCP_SA_KEY}" > "${{ runner.temp }}/gcp_sa.json"
            echo "Wrote service account key to ${{ runner.temp }}/gcp_sa.json"
          else
            echo "No GCP_SA_KEY secret provided; skipping service account write."
          fi

      - name: Set GOOGLE_APPLICATION_CREDENTIALS
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          if [ -n "${GCP_SA_KEY}" ]; then
            echo "GOOGLE_APPLICATION_CREDENTIALS=${{ runner.temp }}/gcp_sa.json" >> $GITHUB_ENV
          else
            echo "No GCP_SA_KEY secret provided; not setting GOOGLE_APPLICATION_CREDENTIALS."
          fi

      - name: Run resend script
        env:
          IMPROVMX_SMTP_USER: ${{ secrets.IMPROVMX_SMTP_USER }}
          IMPROVMX_SMTP_PASS: ${{ secrets.IMPROVMX_SMTP_PASS }}
          IMPROVMX_SMTP_FROM: ${{ secrets.IMPROVMX_SMTP_FROM }}
          IMPROVMX_SMTP_TO: ${{ secrets.IMPROVMX_SMTP_TO }}
          CI: true
        run: python3 scripts/resend_unsent_reports.py --send --yes
