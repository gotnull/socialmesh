name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Scan for secrets
        run: bash ./tool/secret_scan.sh

      - name: Create .env for CI
        run: cp .env.ci .env

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.9"
          channel: "stable"
          cache: true

      - name: Flutter version
        run: flutter --version

      - name: Install dependencies
        run: flutter pub get

      - name: Check formatting
        run: dart format --set-exit-if-changed .

      - name: Analyze
        run: flutter analyze

      - name: Run tests
        run: |
          # Run tests with expanded output, retry once on failure to catch flaky tests
          if ! flutter test --reporter expanded 2>&1 | tee test_output.log; then
            echo "::warning::First test run failed, retrying to check for flaky tests..."
            echo "::group::First Run Failure Details"
            tail -100 test_output.log
            echo "::endgroup::"

            # Retry once
            if ! flutter test --reporter expanded 2>&1 | tee test_output_retry.log; then
              echo "::error::Tests failed on retry - this is a real failure"
              echo "::group::Retry Failure Details"
              tail -200 test_output_retry.log
              echo "::endgroup::"
              exit 1
            else
              echo "::warning::Tests passed on retry - detected flaky test! Check first run output above."
            fi
          fi
