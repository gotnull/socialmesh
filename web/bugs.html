<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bug Reports — Socialmesh Admin</title>
        <meta name="robots" content="noindex, nofollow" />

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/icon?family=Material+Icons"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="landing.css" />

        <!-- Firebase compat SDK (served via Firebase Hosting auto-config) -->
        <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-functions-compat.js"></script>
        <script src="/__/firebase/init.js"></script>

        <style>
            /* Admin page layout */
            .admin-content {
                max-width: 960px;
                margin: 0 auto;
                padding: 100px 24px 80px;
                min-height: 100vh;
            }

            .admin-content h1 {
                font-size: 2rem;
                margin-bottom: 0.5rem;
                background: var(--gradient-brand);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .admin-subtitle {
                color: var(--text-muted);
                font-size: 0.85rem;
                margin-bottom: 2rem;
            }

            /* Auth gate */
            .auth-gate {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 60vh;
                text-align: center;
                gap: 24px;
            }

            .auth-gate h2 {
                font-size: 1.5rem;
                color: var(--text-primary);
            }

            .auth-gate p {
                color: var(--text-secondary);
                max-width: 400px;
            }

            .auth-gate .error-msg {
                color: var(--error);
                font-size: 0.85rem;
            }

            .btn-google {
                display: inline-flex;
                align-items: center;
                gap: 10px;
                padding: 12px 28px;
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                color: var(--text-primary);
                font-family: inherit;
                font-size: 0.9rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
            }

            .btn-google:hover {
                background: var(--bg-card-hover);
                border-color: var(--accent);
            }

            .btn-google svg {
                width: 20px;
                height: 20px;
            }

            /* Toolbar */
            .toolbar {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                gap: 12px;
                margin-bottom: 20px;
                padding-bottom: 16px;
                border-bottom: 1px solid var(--border-color);
            }

            .toolbar-left {
                display: flex;
                align-items: center;
                gap: 12px;
                flex: 1;
                min-width: 0;
            }

            .toolbar-right {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .admin-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                border: 2px solid var(--border-color);
            }

            .admin-name {
                color: var(--text-secondary);
                font-size: 0.8rem;
            }

            .btn-signout {
                padding: 6px 14px;
                background: transparent;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                color: var(--text-muted);
                font-family: inherit;
                font-size: 0.75rem;
                cursor: pointer;
                transition: all 0.2s;
            }

            .btn-signout:hover {
                border-color: var(--error);
                color: var(--error);
            }

            /* Stats bar */
            .stats-bar {
                display: flex;
                gap: 16px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            .stat-pill {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 6px 14px;
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 20px;
                font-size: 0.8rem;
                color: var(--text-secondary);
                cursor: pointer;
                transition: all 0.2s;
                user-select: none;
            }

            .stat-pill:hover {
                border-color: var(--accent);
            }

            .stat-pill.active {
                border-color: var(--accent);
                background: rgba(233, 30, 140, 0.1);
                color: var(--text-primary);
            }

            .stat-pill .count {
                font-weight: 700;
                color: var(--text-primary);
            }

            .stat-pill.active .count {
                color: var(--accent);
            }

            .stat-pill .dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
            }

            .dot-open {
                background: var(--warning);
            }
            .dot-replied {
                background: var(--accent-blue);
            }
            .dot-responded {
                background: var(--accent-purple);
            }
            .dot-resolved {
                background: var(--success);
            }
            .dot-all {
                background: var(--text-muted);
            }

            /* Search */
            .search-box {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 14px;
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 10px;
                flex: 1;
                max-width: 320px;
                transition: border-color 0.2s;
            }

            .search-box:focus-within {
                border-color: var(--accent);
            }

            .search-box .material-icons {
                font-size: 18px;
                color: var(--text-muted);
            }

            .search-box input {
                background: transparent;
                border: none;
                outline: none;
                color: var(--text-primary);
                font-family: inherit;
                font-size: 0.85rem;
                width: 100%;
            }

            .search-box input::placeholder {
                color: var(--text-muted);
            }

            /* Report cards */
            .reports-list {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .report-card {
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                overflow: hidden;
                transition: border-color 0.2s;
            }

            .report-card.has-unread {
                border-color: var(--accent);
                border-width: 1.5px;
            }

            .report-card.expanded {
                border-color: var(--accent-purple);
            }

            .report-header {
                display: flex;
                align-items: flex-start;
                gap: 14px;
                padding: 16px 20px;
                cursor: pointer;
                transition: background 0.15s;
            }

            .report-header:hover {
                background: var(--bg-card-hover);
            }

            .report-header-content {
                flex: 1;
                min-width: 0;
            }

            .report-title {
                font-size: 0.95rem;
                font-weight: 600;
                color: var(--text-primary);
                margin-bottom: 6px;
                line-height: 1.4;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            .report-meta {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                gap: 6px 14px;
                font-size: 0.75rem;
                color: var(--text-muted);
            }

            .report-meta-item {
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .report-meta-item .material-icons {
                font-size: 14px;
            }

            .report-header-right {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                gap: 8px;
                flex-shrink: 0;
            }

            .report-badges {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .unread-badge {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 22px;
                height: 22px;
                padding: 0 6px;
                background: var(--accent);
                border-radius: 11px;
                font-size: 0.7rem;
                font-weight: 700;
                color: white;
            }

            .status-badge {
                display: inline-flex;
                align-items: center;
                gap: 5px;
                padding: 4px 10px;
                border-radius: 8px;
                font-size: 0.7rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.3px;
            }

            .status-open {
                background: rgba(251, 191, 36, 0.15);
                color: var(--warning);
            }

            .status-user_replied {
                background: rgba(79, 106, 246, 0.15);
                color: var(--accent-blue);
            }

            .status-responded {
                background: rgba(139, 92, 246, 0.15);
                color: var(--accent-purple);
            }

            .status-resolved {
                background: rgba(74, 222, 128, 0.15);
                color: var(--success);
            }

            .expand-icon {
                color: var(--text-muted);
                font-size: 20px;
                transition: transform 0.2s;
            }

            .report-card.expanded .expand-icon {
                transform: rotate(180deg);
            }

            /* Expanded content */
            .report-body {
                display: none;
                border-top: 1px solid var(--border-color);
            }

            .report-card.expanded .report-body {
                display: block;
            }

            .report-section {
                padding: 16px 20px;
            }

            .report-section + .report-section {
                border-top: 1px solid rgba(65, 74, 90, 0.5);
            }

            .report-section-label {
                font-size: 0.65rem;
                font-weight: 700;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.8px;
                margin-bottom: 8px;
            }

            .report-description {
                font-size: 0.9rem;
                color: var(--text-secondary);
                line-height: 1.7;
                white-space: pre-wrap;
                word-break: break-word;
            }

            .report-screenshot {
                display: inline-block;
                max-width: 100%;
                max-height: 300px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                cursor: pointer;
                transition: opacity 0.2s;
            }

            .report-screenshot:hover {
                opacity: 0.85;
            }

            /* User info */
            .user-info-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 8px;
            }

            .user-info-item {
                display: flex;
                flex-direction: column;
                gap: 2px;
            }

            .user-info-label {
                font-size: 0.65rem;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .user-info-value {
                font-size: 0.85rem;
                color: var(--text-secondary);
                word-break: break-all;
            }

            /* Thread */
            .thread {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .thread-bubble {
                max-width: 85%;
                padding: 10px 14px;
                border-radius: 12px;
                font-size: 0.85rem;
                line-height: 1.5;
                word-break: break-word;
                white-space: pre-wrap;
                position: relative;
            }

            .thread-bubble.from-user {
                align-self: flex-start;
                background: var(--bg-primary);
                color: var(--text-secondary);
                border-bottom-left-radius: 4px;
            }

            .thread-bubble.from-founder {
                align-self: flex-end;
                background: rgba(233, 30, 140, 0.15);
                color: var(--text-primary);
                border-bottom-right-radius: 4px;
            }

            .thread-bubble-meta {
                font-size: 0.65rem;
                color: var(--text-muted);
                margin-top: 4px;
            }

            .thread-bubble.from-user .thread-bubble-meta {
                text-align: left;
            }

            .thread-bubble.from-founder .thread-bubble-meta {
                text-align: right;
            }

            /* Reply box */
            .reply-box {
                display: flex;
                gap: 10px;
                align-items: flex-end;
                padding: 16px 20px;
                border-top: 1px solid rgba(65, 74, 90, 0.5);
                background: rgba(31, 38, 51, 0.5);
            }

            .reply-textarea {
                flex: 1;
                min-height: 42px;
                max-height: 160px;
                padding: 10px 14px;
                background: var(--bg-primary);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                color: var(--text-primary);
                font-family: inherit;
                font-size: 0.85rem;
                line-height: 1.5;
                resize: vertical;
                outline: none;
                transition: border-color 0.2s;
            }

            .reply-textarea:focus {
                border-color: var(--accent);
            }

            .reply-textarea::placeholder {
                color: var(--text-muted);
            }

            .reply-char-count {
                font-size: 0.65rem;
                color: var(--text-muted);
                text-align: right;
                margin-top: 4px;
            }

            .reply-char-count.near-limit {
                color: var(--warning);
            }

            .reply-char-count.at-limit {
                color: var(--error);
            }

            .reply-input-wrapper {
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            .reply-actions {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }

            .btn-send {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 42px;
                height: 42px;
                background: var(--accent);
                border: none;
                border-radius: 12px;
                color: white;
                cursor: pointer;
                transition: all 0.2s;
            }

            .btn-send:hover {
                background: var(--accent-purple);
                transform: scale(1.05);
            }

            .btn-send:disabled {
                opacity: 0.4;
                cursor: not-allowed;
                transform: none;
            }

            .btn-send .material-icons {
                font-size: 20px;
            }

            .btn-resolve {
                padding: 6px 12px;
                background: transparent;
                border: 1px solid var(--success);
                border-radius: 8px;
                color: var(--success);
                font-family: inherit;
                font-size: 0.7rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                white-space: nowrap;
            }

            .btn-resolve:hover {
                background: rgba(74, 222, 128, 0.15);
            }

            .btn-resolve:disabled {
                opacity: 0.4;
                cursor: not-allowed;
            }

            .btn-reopen {
                padding: 6px 12px;
                background: transparent;
                border: 1px solid var(--warning);
                border-radius: 8px;
                color: var(--warning);
                font-family: inherit;
                font-size: 0.7rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                white-space: nowrap;
            }

            .btn-reopen:hover {
                background: rgba(251, 191, 36, 0.15);
            }

            /* Empty state */
            .empty-state {
                text-align: center;
                padding: 80px 20px;
                color: var(--text-muted);
            }

            .empty-state .material-icons {
                font-size: 48px;
                margin-bottom: 16px;
                opacity: 0.4;
            }

            .empty-state p {
                font-size: 0.9rem;
            }

            /* Loading */
            .loading-spinner {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 60px;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .spinner {
                width: 32px;
                height: 32px;
                border: 3px solid var(--border-color);
                border-top-color: var(--accent);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }

            /* Toast */
            .toast {
                position: fixed;
                bottom: 24px;
                left: 50%;
                transform: translateX(-50%) translateY(80px);
                padding: 12px 24px;
                border-radius: 12px;
                font-size: 0.85rem;
                font-weight: 500;
                z-index: 1000;
                transition: transform 0.3s var(--ease-out-expo);
                pointer-events: none;
            }

            .toast.visible {
                transform: translateX(-50%) translateY(0);
            }

            .toast.success {
                background: var(--success);
                color: #000;
            }

            .toast.error {
                background: var(--error);
                color: #fff;
            }

            /* Fullscreen overlay */
            .fullscreen-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.92);
                z-index: 999;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                opacity: 0;
                transition: opacity 0.25s;
            }

            .fullscreen-overlay.visible {
                opacity: 1;
            }

            .fullscreen-overlay img {
                max-width: 90vw;
                max-height: 90vh;
                border-radius: 8px;
                object-fit: contain;
            }

            .fullscreen-close {
                position: absolute;
                top: 20px;
                right: 20px;
                background: rgba(255, 255, 255, 0.1);
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                color: white;
                transition: background 0.2s;
            }

            .fullscreen-close:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            /* Responsive */
            @media (max-width: 640px) {
                .admin-content {
                    padding: 80px 16px 60px;
                }

                .admin-content h1 {
                    font-size: 1.5rem;
                }

                .stats-bar {
                    gap: 8px;
                }

                .stat-pill {
                    padding: 5px 10px;
                    font-size: 0.72rem;
                }

                .report-header {
                    padding: 12px 14px;
                    gap: 10px;
                }

                .report-section {
                    padding: 12px 14px;
                }

                .reply-box {
                    padding: 12px 14px;
                }

                .thread-bubble {
                    max-width: 92%;
                }

                .toolbar {
                    flex-direction: column;
                    align-items: stretch;
                }

                .search-box {
                    max-width: none;
                }
            }
        </style>
    </head>

    <body>
        <div class="mesh-bg"></div>
        <div class="grid-overlay"></div>

        <nav>
            <div class="container">
                <a href="/" class="logo">
                    <img
                        src="images/app-icon.png"
                        alt="Socialmesh"
                        class="logo-img"
                    />
                    <span class="logo-text">Socialmesh</span>
                </a>
                <div class="nav-cta">
                    <a href="/" class="btn btn-secondary"
                        >&larr; Back to Home</a
                    >
                </div>
            </div>
        </nav>

        <div class="admin-content">
            <!-- Auth gate -->
            <div id="auth-gate" class="auth-gate">
                <h2>Bug Reports Admin</h2>
                <p>
                    Sign in with your admin Google account to view and respond
                    to bug reports.
                </p>
                <button class="btn-google" onclick="signIn()">
                    <svg viewBox="0 0 24 24">
                        <path
                            fill="#4285F4"
                            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.27-4.74 3.27-8.1z"
                        />
                        <path
                            fill="#34A853"
                            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                        />
                        <path
                            fill="#FBBC05"
                            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                        />
                        <path
                            fill="#EA4335"
                            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                        />
                    </svg>
                    Sign in with Google
                </button>
                <p id="auth-error" class="error-msg" style="display: none"></p>
            </div>

            <!-- Admin panel (hidden until authed) -->
            <div id="admin-panel" style="display: none">
                <h1>Bug Reports</h1>
                <p class="admin-subtitle">
                    Manage user-submitted bug reports and respond to feedback.
                </p>

                <div class="toolbar">
                    <div class="toolbar-left">
                        <div class="search-box">
                            <span class="material-icons">search</span>
                            <input
                                type="text"
                                id="search-input"
                                placeholder="Search reports..."
                                oninput="filterReports()"
                            />
                        </div>
                    </div>
                    <div class="toolbar-right">
                        <img
                            id="admin-avatar"
                            class="admin-avatar"
                            src=""
                            alt=""
                            style="display: none"
                        />
                        <span id="admin-name" class="admin-name"></span>
                        <button class="btn-signout" onclick="signOut()">
                            Sign out
                        </button>
                    </div>
                </div>

                <div class="stats-bar" id="stats-bar">
                    <div
                        class="stat-pill active"
                        data-filter="all"
                        onclick="setFilter('all')"
                    >
                        <span class="dot dot-all"></span>
                        All <span class="count" id="count-all">0</span>
                    </div>
                    <div
                        class="stat-pill"
                        data-filter="open"
                        onclick="setFilter('open')"
                    >
                        <span class="dot dot-open"></span>
                        Open <span class="count" id="count-open">0</span>
                    </div>
                    <div
                        class="stat-pill"
                        data-filter="user_replied"
                        onclick="setFilter('user_replied')"
                    >
                        <span class="dot dot-replied"></span>
                        User Replied
                        <span class="count" id="count-replied">0</span>
                    </div>
                    <div
                        class="stat-pill"
                        data-filter="responded"
                        onclick="setFilter('responded')"
                    >
                        <span class="dot dot-responded"></span>
                        Responded
                        <span class="count" id="count-responded">0</span>
                    </div>
                    <div
                        class="stat-pill"
                        data-filter="resolved"
                        onclick="setFilter('resolved')"
                    >
                        <span class="dot dot-resolved"></span>
                        Resolved
                        <span class="count" id="count-resolved">0</span>
                    </div>
                </div>

                <div id="reports-container">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast notification -->
        <div id="toast" class="toast"></div>

        <!-- Fullscreen image overlay -->
        <div
            id="fullscreen-overlay"
            class="fullscreen-overlay"
            onclick="closeFullscreen()"
        >
            <button class="fullscreen-close" onclick="closeFullscreen()">
                <span class="material-icons">close</span>
            </button>
            <img id="fullscreen-img" src="" alt="Screenshot" />
        </div>

        <footer class="page-footer">
            <div class="container">
                <div class="page-footer-links">
                    <a href="/privacy">Privacy Policy</a>
                    <a href="/terms">Terms of Service</a>
                    <a href="/support">Support</a>
                    <a href="/docs">Documentation</a>
                    <a href="/faq">FAQ</a>
                </div>
                <p class="page-footer-copyright">
                    &copy; 2026 Socialmesh. All rights reserved.
                </p>
            </div>
        </footer>

        <script>
            // State
            const db = firebase.firestore();
            const auth = firebase.auth();
            const functions = firebase.functions();

            let allReports = [];
            let currentFilter = "all";
            let searchQuery = "";
            let unsubscribe = null;

            // Admin UID (hardcoded fallback + Firestore admins collection check)
            const ADMIN_UIDS = ["9ltxJGViWHW5aj5HhLGmiVwkrLU2"];

            // =========================================================================
            // Auth
            // =========================================================================

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const isAdminUser = await checkAdmin(user.uid);
                    if (isAdminUser) {
                        showAdminPanel(user);
                    } else {
                        document.getElementById("auth-error").textContent =
                            "Access denied. This account is not an admin.";
                        document.getElementById("auth-error").style.display =
                            "block";
                        auth.signOut();
                    }
                } else {
                    showAuthGate();
                }
            });

            async function checkAdmin(uid) {
                if (ADMIN_UIDS.includes(uid)) return true;
                try {
                    const doc = await db.collection("admins").doc(uid).get();
                    return doc.exists;
                } catch {
                    return false;
                }
            }

            function signIn() {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).catch((err) => {
                    document.getElementById("auth-error").textContent =
                        err.message;
                    document.getElementById("auth-error").style.display =
                        "block";
                });
            }

            function signOut() {
                if (unsubscribe) unsubscribe();
                auth.signOut();
            }

            function showAuthGate() {
                document.getElementById("auth-gate").style.display = "flex";
                document.getElementById("admin-panel").style.display = "none";
            }

            function showAdminPanel(user) {
                document.getElementById("auth-gate").style.display = "none";
                document.getElementById("admin-panel").style.display = "block";

                if (user.photoURL) {
                    document.getElementById("admin-avatar").src = user.photoURL;
                    document.getElementById("admin-avatar").style.display =
                        "block";
                }
                document.getElementById("admin-name").textContent =
                    user.displayName || user.email || "";

                subscribeToReports();
            }

            // =========================================================================
            // Data
            // =========================================================================

            function subscribeToReports() {
                if (unsubscribe) unsubscribe();

                const container = document.getElementById("reports-container");
                container.innerHTML =
                    '<div class="loading-spinner"><div class="spinner"></div></div>';

                unsubscribe = db
                    .collection("bugReports")
                    .orderBy("createdAt", "desc")
                    .onSnapshot(
                        async (snapshot) => {
                            const reports = [];
                            for (const doc of snapshot.docs) {
                                const data = doc.data();
                                const responsesSnap = await doc.ref
                                    .collection("responses")
                                    .orderBy("createdAt", "asc")
                                    .get();

                                const responses = responsesSnap.docs.map(
                                    (r) => ({
                                        id: r.id,
                                        ...r.data(),
                                    }),
                                );

                                reports.push({
                                    id: doc.id,
                                    ...data,
                                    responses,
                                    hasUnread: responses.some(
                                        (r) =>
                                            r.from === "user" && !r.readByAdmin,
                                    ),
                                });
                            }
                            allReports = reports;
                            updateStats();
                            renderReports();
                        },
                        (error) => {
                            console.error("Firestore listener error:", error);
                            container.innerHTML =
                                '<div class="empty-state"><span class="material-icons">error_outline</span><p>Failed to load reports: ' +
                                escapeHtml(error.message) +
                                "</p></div>";
                        },
                    );
            }

            // =========================================================================
            // Rendering
            // =========================================================================

            function updateStats() {
                const counts = {
                    all: 0,
                    open: 0,
                    user_replied: 0,
                    responded: 0,
                    resolved: 0,
                };
                counts.all = allReports.length;
                for (const r of allReports) {
                    const s = r.status || "open";
                    if (counts[s] !== undefined) counts[s]++;
                }
                document.getElementById("count-all").textContent = counts.all;
                document.getElementById("count-open").textContent = counts.open;
                document.getElementById("count-replied").textContent =
                    counts.user_replied;
                document.getElementById("count-responded").textContent =
                    counts.responded;
                document.getElementById("count-resolved").textContent =
                    counts.resolved;

                // Update page title with unread
                const needsAttention = counts.open + counts.user_replied;
                document.title =
                    needsAttention > 0
                        ? `(${needsAttention}) Bug Reports — Socialmesh Admin`
                        : "Bug Reports — Socialmesh Admin";
            }

            function getFilteredReports() {
                let filtered = allReports;

                if (currentFilter !== "all") {
                    filtered = filtered.filter(
                        (r) => (r.status || "open") === currentFilter,
                    );
                }

                if (searchQuery) {
                    const q = searchQuery.toLowerCase();
                    filtered = filtered.filter(
                        (r) =>
                            (r.description || "").toLowerCase().includes(q) ||
                            (r.uid || "").toLowerCase().includes(q) ||
                            (r.email || "").toLowerCase().includes(q) ||
                            (r.platform || "").toLowerCase().includes(q) ||
                            r.id.toLowerCase().includes(q),
                    );
                }

                return filtered;
            }

            function renderReports() {
                const container = document.getElementById("reports-container");
                const filtered = getFilteredReports();

                if (filtered.length === 0) {
                    container.innerHTML =
                        '<div class="empty-state">' +
                        '<span class="material-icons">inbox</span>' +
                        "<p>" +
                        (allReports.length === 0
                            ? "No bug reports yet."
                            : "No reports match your filter.") +
                        "</p>" +
                        "</div>";
                    return;
                }

                container.innerHTML =
                    '<div class="reports-list">' +
                    filtered.map(renderReportCard).join("") +
                    "</div>";
            }

            function renderReportCard(report) {
                const status = report.status || "open";
                const statusLabel =
                    {
                        open: "Open",
                        responded: "Responded",
                        user_replied: "User Replied",
                        resolved: "Resolved",
                    }[status] || status;

                const date = formatDate(report.createdAt);
                const desc = report.description || "";
                const preview =
                    desc.length > 120 ? desc.substring(0, 117) + "..." : desc;
                const responseCount = report.responses
                    ? report.responses.length
                    : 0;
                const hasUnread = report.hasUnread;
                const classes = ["report-card"];
                if (hasUnread) classes.push("has-unread");

                let userReplies = 0;
                if (report.responses) {
                    userReplies = report.responses.filter(
                        (r) => r.from === "user" && !r.readByAdmin,
                    ).length;
                }

                return `
        <div class="${classes.join(" ")}" id="report-${report.id}">
          <div class="report-header" onclick="toggleReport('${report.id}')">
            <div class="report-header-content">
              <div class="report-title">${escapeHtml(preview)}</div>
              <div class="report-meta">
                <span class="report-meta-item">
                  <span class="material-icons">schedule</span> ${date}
                </span>
                ${
                    report.platform
                        ? `<span class="report-meta-item">
                  <span class="material-icons">devices</span> ${escapeHtml(report.platform)}
                </span>`
                        : ""
                }
                ${
                    report.appVersion
                        ? `<span class="report-meta-item">
                  <span class="material-icons">label</span> v${escapeHtml(report.appVersion)}
                </span>`
                        : ""
                }
                ${
                    responseCount > 0
                        ? `<span class="report-meta-item">
                  <span class="material-icons">chat_bubble_outline</span> ${responseCount}
                </span>`
                        : ""
                }
              </div>
            </div>
            <div class="report-header-right">
              <div class="report-badges">
                ${userReplies > 0 ? `<span class="unread-badge">${userReplies}</span>` : ""}
                <span class="status-badge status-${status}">${statusLabel}</span>
              </div>
              <span class="material-icons expand-icon">expand_more</span>
            </div>
          </div>
          <div class="report-body">
            <div class="report-section">
              <div class="report-section-label">Description</div>
              <div class="report-description">${escapeHtml(desc)}</div>
            </div>
            ${
                report.screenshotUrl
                    ? `
            <div class="report-section">
              <div class="report-section-label">Screenshot</div>
              <img class="report-screenshot" src="${escapeHtml(report.screenshotUrl)}"
                onclick="event.stopPropagation(); showFullscreen('${escapeHtml(report.screenshotUrl)}')"
                alt="Bug screenshot" loading="lazy">
            </div>`
                    : ""
            }
            <div class="report-section">
              <div class="report-section-label">Details</div>
              <div class="user-info-grid">
                <div class="user-info-item">
                  <span class="user-info-label">Report ID</span>
                  <span class="user-info-value">${report.id}</span>
                </div>
                <div class="user-info-item">
                  <span class="user-info-label">User ID</span>
                  <span class="user-info-value">${escapeHtml(report.uid || "anonymous")}</span>
                </div>
                ${
                    report.email
                        ? `<div class="user-info-item">
                  <span class="user-info-label">Email</span>
                  <span class="user-info-value">${escapeHtml(report.email)}</span>
                </div>`
                        : ""
                }
                ${
                    report.platformVersion
                        ? `<div class="user-info-item">
                  <span class="user-info-label">OS Version</span>
                  <span class="user-info-value">${escapeHtml(report.platformVersion)}</span>
                </div>`
                        : ""
                }
                ${
                    report.buildNumber
                        ? `<div class="user-info-item">
                  <span class="user-info-label">Build</span>
                  <span class="user-info-value">${escapeHtml(report.buildNumber)}</span>
                </div>`
                        : ""
                }
              </div>
            </div>
            ${
                responseCount > 0
                    ? `
            <div class="report-section">
              <div class="report-section-label">Conversation</div>
              <div class="thread">
                ${report.responses.map(renderBubble).join("")}
              </div>
            </div>`
                    : ""
            }
            <div class="reply-box">
              <div class="reply-input-wrapper">
                <textarea class="reply-textarea" id="reply-${report.id}"
                  placeholder="Write a response..." maxlength="2000"
                  oninput="updateCharCount('${report.id}')"
                  onkeydown="handleReplyKey(event, '${report.id}')"></textarea>
                <div class="reply-char-count" id="char-count-${report.id}">0 / 2,000</div>
              </div>
              <div class="reply-actions">
                <button class="btn-send" id="send-${report.id}"
                  onclick="sendResponse('${report.id}')" title="Send response">
                  <span class="material-icons">send</span>
                </button>
                ${
                    status !== "resolved"
                        ? `
                  <button class="btn-resolve" onclick="updateStatus('${report.id}', 'resolved')"
                    title="Mark as resolved">Resolve</button>
                `
                        : `
                  <button class="btn-reopen" onclick="updateStatus('${report.id}', 'open')"
                    title="Reopen report">Reopen</button>
                `
                }
              </div>
            </div>
          </div>
        </div>`;
            }

            function renderBubble(response) {
                const from = response.from === "founder" ? "founder" : "user";
                const label = from === "founder" ? "You" : "User";
                const date = formatDate(response.createdAt);
                return `
        <div class="thread-bubble from-${from}">
          ${escapeHtml(response.message || "")}
          <div class="thread-bubble-meta">${label} &middot; ${date}</div>
        </div>`;
            }

            // =========================================================================
            // Actions
            // =========================================================================

            function toggleReport(reportId) {
                const el = document.getElementById("report-" + reportId);
                if (!el) return;
                const wasExpanded = el.classList.contains("expanded");
                el.classList.toggle("expanded");

                // Mark user replies as read by admin when expanding
                if (!wasExpanded) {
                    markAdminRead(reportId);
                }
            }

            async function markAdminRead(reportId) {
                try {
                    const responsesSnap = await db
                        .collection("bugReports")
                        .doc(reportId)
                        .collection("responses")
                        .where("from", "==", "user")
                        .where("readByAdmin", "==", false)
                        .get();

                    if (responsesSnap.empty) return;

                    const batch = db.batch();
                    responsesSnap.docs.forEach((doc) => {
                        batch.update(doc.ref, { readByAdmin: true });
                    });
                    await batch.commit();
                } catch (e) {
                    console.warn("Failed to mark as read:", e);
                }
            }

            async function sendResponse(reportId) {
                const textarea = document.getElementById("reply-" + reportId);
                const sendBtn = document.getElementById("send-" + reportId);
                const message = textarea.value.trim();

                if (!message) return;
                if (message.length > 2000) {
                    showToast("Message exceeds 2,000 characters.", "error");
                    return;
                }

                sendBtn.disabled = true;
                textarea.disabled = true;

                try {
                    const callable =
                        functions.httpsCallable("respondToBugReport");
                    await callable({ reportId, message });

                    textarea.value = "";
                    updateCharCount(reportId);
                    showToast("Response sent successfully.", "success");
                } catch (err) {
                    console.error("Send failed:", err);
                    showToast(
                        "Failed to send: " + (err.message || err),
                        "error",
                    );
                } finally {
                    sendBtn.disabled = false;
                    textarea.disabled = false;
                    textarea.focus();
                }
            }

            async function updateStatus(reportId, newStatus) {
                try {
                    await db.collection("bugReports").doc(reportId).update({
                        status: newStatus,
                        lastResponseAt:
                            firebase.firestore.FieldValue.serverTimestamp(),
                    });
                    showToast(
                        newStatus === "resolved"
                            ? "Report marked as resolved."
                            : "Report reopened.",
                        "success",
                    );
                } catch (err) {
                    showToast(
                        "Failed to update status: " + err.message,
                        "error",
                    );
                }
            }

            function handleReplyKey(event, reportId) {
                // Cmd/Ctrl+Enter to send
                if (event.key === "Enter" && (event.metaKey || event.ctrlKey)) {
                    event.preventDefault();
                    sendResponse(reportId);
                }
            }

            function updateCharCount(reportId) {
                const textarea = document.getElementById("reply-" + reportId);
                const counter = document.getElementById(
                    "char-count-" + reportId,
                );
                if (!textarea || !counter) return;

                const len = textarea.value.length;
                counter.textContent = len.toLocaleString() + " / 2,000";
                counter.className = "reply-char-count";
                if (len >= 2000) {
                    counter.classList.add("at-limit");
                } else if (len >= 1800) {
                    counter.classList.add("near-limit");
                }
            }

            // =========================================================================
            // Filters
            // =========================================================================

            function setFilter(filter) {
                currentFilter = filter;
                document.querySelectorAll(".stat-pill").forEach((el) => {
                    el.classList.toggle("active", el.dataset.filter === filter);
                });
                renderReports();
            }

            function filterReports() {
                searchQuery = document
                    .getElementById("search-input")
                    .value.trim();
                renderReports();
            }

            // =========================================================================
            // Fullscreen
            // =========================================================================

            function showFullscreen(url) {
                const overlay = document.getElementById("fullscreen-overlay");
                const img = document.getElementById("fullscreen-img");
                img.src = url;
                overlay.style.display = "flex";
                requestAnimationFrame(() => overlay.classList.add("visible"));
                document.body.style.overflow = "hidden";
            }

            function closeFullscreen() {
                const overlay = document.getElementById("fullscreen-overlay");
                overlay.classList.remove("visible");
                setTimeout(() => {
                    overlay.style.display = "none";
                    document.getElementById("fullscreen-img").src = "";
                }, 250);
                document.body.style.overflow = "";
            }

            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") closeFullscreen();
            });

            // =========================================================================
            // Utilities
            // =========================================================================

            function escapeHtml(str) {
                if (!str) return "";
                const div = document.createElement("div");
                div.textContent = str;
                return div.innerHTML;
            }

            function formatDate(ts) {
                if (!ts) return "";
                let date;
                if (ts.toDate) {
                    date = ts.toDate();
                } else if (ts.seconds) {
                    date = new Date(ts.seconds * 1000);
                } else {
                    date = new Date(ts);
                }
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return "just now";
                if (diffMins < 60) return diffMins + "m ago";
                if (diffHours < 24) return diffHours + "h ago";
                if (diffDays < 7) return diffDays + "d ago";

                return (
                    date.toLocaleDateString("en-GB", {
                        day: "numeric",
                        month: "short",
                        year:
                            date.getFullYear() !== now.getFullYear()
                                ? "numeric"
                                : undefined,
                    }) +
                    ", " +
                    date.toLocaleTimeString("en-GB", {
                        hour: "2-digit",
                        minute: "2-digit",
                    })
                );
            }

            let toastTimeout;
            function showToast(message, type) {
                const toast = document.getElementById("toast");
                toast.textContent = message;
                toast.className = "toast " + type;
                clearTimeout(toastTimeout);
                requestAnimationFrame(() => {
                    toast.classList.add("visible");
                    toastTimeout = setTimeout(() => {
                        toast.classList.remove("visible");
                    }, 3000);
                });
            }
        </script>
    </body>
</html>
